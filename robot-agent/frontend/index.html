<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Robot Agent Chat</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7fb; }
    .app { max-width: 800px; margin: 0 auto; padding: 24px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .row { display: flex; gap: 8px; }
    #input { flex: 1; font-size: 16px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; }
    button { padding: 10px 14px; border: none; border-radius: 8px; background: #111827; color: #fff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: default; }
    .messages { margin-top: 12px; height: 360px; overflow: auto; padding-right: 4px; }
    .msg { margin: 8px 0; }
    .msg.user { text-align: right; }
    .msg .bubble { display: inline-block; padding: 10px 12px; border-radius: 12px; }
    .msg.user .bubble { background: #111827; color: #fff; }
    .msg.bot .bubble { background: #e5e7eb; color: #111827; }
    .panel { margin-top: 16px; display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    pre { background: #111827; color: #e5e7eb; padding: 8px; border-radius: 8px; overflow: auto; }
    small { color: #6b7280; }
  </style>
</head>
<body>
  <div class="app">
    <h2>Robot Agent Chat</h2>
    <div class="card">
      <div class="row">
        <input id="input" placeholder="e.g., move blue cube to 1" />
        <button id="send">Send</button>
      </div>
      <div class="messages" id="messages"></div>
      <div class="panel">
        <div>
          <h4>Status</h4>
          <pre id="status"><small>fetching…</small></pre>
        </div>
        <div>
          <h4>Config</h4>
          <pre id="config"><small>fetching…</small></pre>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h4>Map</h4>
      <pre id="map"><small>fetching…</small></pre>
    </div>
  </div>

  <script>
    const server = (localStorage.getItem('server') || 'http://127.0.0.1:8000').replace(/\/$/, '');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const statusEl = document.getElementById('status');
    const configEl = document.getElementById('config');
    const mapEl = document.getElementById('map');

    async function api(path, method='GET', body) {
      const res = await fetch(server + path, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      div.appendChild(b);
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function refreshStatus() {
      try {
        const s = await api('/status');
        statusEl.textContent = JSON.stringify(s, null, 2);
      } catch (e) {
        statusEl.textContent = String(e);
      }
    }
    async function refreshConfig() {
      try {
        const s = await api('/config');
        configEl.textContent = JSON.stringify(s, null, 2);
      } catch (e) {
        configEl.textContent = String(e);
      }
    }

    async function refreshMap() {
      try {
        const s = await api('/map');
        mapEl.textContent = s.map;
      } catch (e) {
        mapEl.textContent = String(e);
      }
    }

    async function handleSend() {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addMsg('user', text);

      // Minimal intent parsing matching CLI fallback
      const m = text.toLowerCase().match(/^move\s+([a-z0-9_\- ]+)\s+to\s+([a-z0-9_\-]+)$/);
      let payload = null;
      if (m) {
        const object_id = m[1].replace(/\s+/g, '_');
        const target = m[2];
        payload = { name: 'move_object', arguments: { object_id, target } };
      } else if (text.toLowerCase() === 'status') {
        payload = { name: 'query_status', arguments: {} };
      }

      try {
        if (payload) {
          const res = await api('/tool-call', 'POST', payload);
          addMsg('bot', res.ok ? 'ok' : ('error: ' + (res.error || 'unknown')));
          await refreshStatus();
          await refreshConfig();
    refreshMap();
    setInterval(refreshMap, 4000);
          await refreshMap();
        } else {
          addMsg('bot', 'Try: "move blue cube to 1" or "status"');
        }
      } catch (e) {
        addMsg('bot', 'HTTP error: ' + e.message);
      }
    }

    send.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });

    refreshStatus();
    refreshConfig();
    refreshMap();
    setInterval(refreshMap, 4000);
    setInterval(refreshStatus, 4000);
  </script>
</body>
</html>

