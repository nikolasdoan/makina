<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Makina</title>
  <style>
    :root { --gap: 14px; --bd: #e5e7eb; --bg: #f6f7fb; --card: #fff; --text: #111827; --muted: #6b7280; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; overflow-y: auto; overflow-x: hidden; }
    .layout { display: grid; grid-template-columns: 56px 1fr; height: 100vh; }
    .sidebar { background: #0f172a; color: #cbd5e1; display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 14px; }
    .sb-icon { width: 24px; height: 24px; opacity: 0.9; }
    .main { display: flex; flex-direction: column; height: 100%; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; }
    .title { font-weight: 700; font-size: 18px; }
    .badge { font-size: 12px; color: var(--muted); }
    .banner { display:none; margin: 0 16px 4px; padding: 8px 10px; background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; border-radius:8px; }
    .banner button { margin-left: 8px; background:#9a3412; color:#fff; border:none; border-radius:6px; padding:6px 10px; }
    .chips { display:flex; gap:8px; padding: 0 16px 8px; flex-wrap: wrap; }
    .chip { padding: 6px 10px; border:1px solid var(--bd); border-radius: 999px; font-size: 12px; background:#fff; color:#334155; }

    .content { flex:1; padding: 0 12px 12px; }
    .grid { display: grid; grid-template-columns: minmax(280px, 2fr) minmax(360px, 2fr) minmax(280px, 1.8fr); gap: var(--gap); height: 100%; align-items: stretch; }
    .col { display:flex; flex-direction: column; gap: var(--gap); height: 100%; min-width: 0; }
    .card { background: var(--card); border: 1px solid var(--bd); border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); display:flex; flex-direction: column; min-height: 0; }
    .card h4 { margin: 0 0 8px; }
    .row { display:flex; gap:8px; }
    #input { flex:1; font-size:16px; padding:10px 12px; border:1px solid var(--bd); border-radius:8px; outline:none; }
    button { padding:10px 14px; border:none; border-radius:8px; background:#111827; color:#fff; cursor:pointer; }
    .messages { flex:1; min-height: clamp(180px, 36vh, 420px); overflow:auto; margin-top:10px; }
    .msg { margin:8px 0; }
    .msg .bubble { display:inline-block; padding:10px 12px; border-radius:12px; }
    .msg.user { text-align:right; }
    .msg.user .bubble { background:#fef9c3; color:#374151; }
    .msg.bot .bubble { background:#e5e7eb; color:#111827; }
    pre { background:#111827; color:#e5e7eb; padding:8px; border-radius:8px; overflow:auto; }
    .panel-fixed pre { height: clamp(140px, 22vh, 220px); }
    .map pre { flex: 1; min-height: clamp(260px, 48vh, 520px); }
    .quick { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .qbtn { font-size:12px; padding:6px 10px; border:1px solid var(--bd); border-radius:999px; background:#fff; color:#334155; }
    .map-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
    .icon-btn { background:#fff; color:#111827; border:1px solid var(--bd); padding:6px 8px; border-radius:8px; }
  
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 820px) {
      .layout { grid-template-columns: 48px 1fr; }
      .grid { grid-template-columns: 1fr; }
      .messages { min-height: 220px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/></svg>
      <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
      <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 12h16M12 4v16"/></svg>
      <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 9h8v6H8z"/></svg>
      <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 12l5 5L20 7"/></svg>
    </aside>
    <main class="main">
      <div class="header">
        <div class="title">Makina</div>
        <div class="badge" id="modelBadge">LLM: checking…</div>
      </div>
      <div class="banner" id="llmBannerTop">LLM inactive. <button id="bannerActivate">Activate LLM</button></div>
      <div class="chips">
        <div class="chip">Objects</div>
        <div class="chip">Zones</div>
        <div class="chip">LLM</div>
        <div class="chip">Safety</div>
        <div class="chip">Speed</div>
        <div class="chip">Logs</div>
      </div>
      <div class="content">
        <div class="grid">
          <div class="col">
            <div class="card panel-fixed">
              <h4>Status</h4>
              <pre id="status"><small>fetching…</small></pre>
            </div>
            <div class="card panel-fixed">
              <h4>Config</h4>
              <pre id="config"><small>fetching…</small></pre>
            </div>
            <div class="card">
              <h4>LLM</h4>
              <div class="row" style="gap:8px; margin-bottom:8px;">
                <input id="apiKey" placeholder="OpenAI API Key" style="flex:1; padding:8px; border:1px solid var(--bd); border-radius:8px;" />
                <input id="model" placeholder="Model (gpt-4o-mini)" style="width:180px; padding:8px; border:1px solid var(--bd); border-radius:8px;" />
              </div>
              <div class="row">
                <button id="btnActivate" style="background:#065f46">Activate</button>
                <button id="btnDeactivate" style="background:#b91c1c">Deactivate</button>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card map">
              <div class="map-head"><h4>Map</h4><button class="icon-btn" id="btnMapRefresh">Refresh</button></div>
              <pre id="map"><small>fetching…</small></pre>
            </div>
          </div>
          <div class="col">
            <div class="card chat">
              <div class="row">
                <input id="input" placeholder="e.g., move blue cube to 1" />
                <button id="send">Send</button>
              </div>
              <div class="quick">
                <button class="qbtn" data-cmd="status">status</button>
                <button class="qbtn" data-cmd="move blue cube to 1">move blue→1</button>
                <button class="qbtn" data-cmd="move red cube to 2">move red→2</button>
                <button class="qbtn" data-cmd="stop">stop</button>
                <button class="qbtn" data-cmd="set speed 0.3">set speed 0.3</button>
              </div>
              <div class="messages" id="messages"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
<script>
    const server = (localStorage.getItem('server') || 'http://127.0.0.1:8000').replace(/\/$/, '');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const statusEl = document.getElementById('status');
    const configEl = document.getElementById('config');
    const mapEl = document.getElementById('map');
    const apiKeyEl = document.getElementById('apiKey');
    const modelEl = document.getElementById('model');
    const btnActivate = document.getElementById('btnActivate');
    const btnDeactivate = document.getElementById('btnDeactivate');

    async function api(path, method='GET', body) {
      const res = await fetch(server + path, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      div.appendChild(b);
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function refreshStatus() {
      try {
        const s = await api('/status');
        statusEl.textContent = JSON.stringify(s, null, 2);
        const badge = document.getElementById('modelBadge');
        const topBanner = document.getElementById('llmBannerTop');
        if (badge) { badge.textContent = 'LLM: ' + ((s.llm && s.llm.active) ? 'active' : 'inactive') + (s.llm && s.llm.model ? ', ' + s.llm.model : ''); }
        if (topBanner) { topBanner.style.display = (s.llm && s.llm.active) ? 'none' : 'block'; }
      } catch (e) {
        statusEl.textContent = String(e);
        const badge = document.getElementById('modelBadge'); if (badge) badge.textContent = 'LLM: unknown';
      }
    }
    async function refreshConfig() {
      try {
        const s = await api('/config');
        configEl.textContent = JSON.stringify(s, null, 2);
      } catch (e) {
        configEl.textContent = String(e);
      }
    }

    async function refreshMap() {
      try {
        const s = await api('/map');
        mapEl.textContent = s.map;
      } catch (e) {
        mapEl.textContent = String(e);
      }
    }

    async function handleSend() {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addMsg('user', text);
      try {
        const res = await api('/chat', 'POST', { text });
        if (res.ok) {
          addMsg('bot', res.assistant || 'ok');
        } else {
          addMsg('bot', 'error: ' + (res.error || 'unknown'));
        }
        await refreshStatus();
        await refreshConfig();
        await refreshMap();
      } catch (e) {
        addMsg('bot', 'HTTP error: ' + e.message);
      }
    }

        send.addEventListener('click', handleSend);
    btnActivate && btnActivate.addEventListener('click', async () => {
      const api_key = apiKeyEl.value.trim();
      const model = modelEl.value.trim() || 'gpt-4o-mini';
      try {
        const res = await api('/llm/activate', 'POST', { api_key, model });
        addMsg('bot', res.ok ? 'LLM activated' : ('activate error: ' + (res.error || 'unknown')));
        await refreshStatus();
      } catch (e) { addMsg('bot', 'HTTP error: ' + e.message); }
    });
    const bannerBtn = document.getElementById('bannerActivate');
    if (bannerBtn) bannerBtn.addEventListener('click', async ()=>{
      const api_key = (document.getElementById('apiKey')||{}).value || '';
      const model = (document.getElementById('model')||{}).value || 'gpt-4o-mini';
      try { const res = await api('/llm/activate', 'POST', { api_key, model }); await refreshStatus(); } catch(e){}
    });
    btnDeactivate && btnDeactivate.addEventListener('click', async () => {
      try {
        const res = await api('/llm/deactivate', 'POST', {});
        addMsg('bot', res.ok ? 'LLM deactivated' : 'deactivate failed');
        await refreshStatus();
      } catch (e) { addMsg('bot', 'HTTP error: ' + e.message); }
    });
    document.querySelectorAll('.qbtn').forEach(btn=>btn.addEventListener('click', ()=>{ input.value = btn.getAttribute('data-cmd'); handleSend(); }));
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });

    refreshStatus();
    refreshConfig();
    refreshMap();
    setInterval(refreshMap, 4000);
    setInterval(refreshStatus, 4000);
  </script>
</body>
</html>

